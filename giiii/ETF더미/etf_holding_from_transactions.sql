-- ETF 거래 내역을 holding 테이블에 반영하는 쿼리
-- 모든 거래 내역을 순차적으로 반영

-- ==============================================
-- 2025년 2월 거래 내역 반영
-- ==============================================

-- 1. ETF ID 1 (BUY 15주, 가격 9,390원)
-- 기존: 28주 @ 10,020원 → 신규: 43주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 43.000000,
    avg_cost = ROUND(((28.000000 * 10020.00) + (15.000000 * 9390.00)) / 43.000000, 2),
    updated_at = '2025-02-03 09:45:00'
WHERE etf_id = 1 AND isa_account_id = 6;

-- 2. ETF ID 26 (SELL 10주, 가격 32,650원) 
-- 기존: 27주 @ 32,010원 → 신규: 17주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 17.000000,
    updated_at = '2025-02-03 10:30:00'
WHERE etf_id = 26 AND isa_account_id = 6;

-- 3. ETF ID 40 (BUY 20주, 가격 32,900원)
-- 기존: 32주 @ 32,215원 → 신규: 52주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 52.000000,
    avg_cost = ROUND(((32.000000 * 32215.00) + (20.000000 * 32900.00)) / 52.000000, 2),
    updated_at = '2025-02-03 11:15:00'
WHERE etf_id = 40 AND isa_account_id = 6;

-- 4. ETF ID 318 (SELL 8주, 가격 10,400원)
-- 기존: 22주 @ 10,095원 → 신규: 14주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 14.000000,
    updated_at = '2025-02-03 14:20:00'
WHERE etf_id = 318 AND isa_account_id = 6;

-- 5. ETF ID 353 (BUY 25주, 가격 13,320원)
-- 기존: 42주 @ 12,135원 → 신규: 67주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 67.000000,
    avg_cost = ROUND(((42.000000 * 12135.00) + (25.000000 * 13320.00)) / 67.000000, 2),
    updated_at = '2025-02-03 15:30:00'
WHERE etf_id = 353 AND isa_account_id = 6;

-- ==============================================
-- 2025년 3월 거래 내역 반영
-- ==============================================

-- 6. ETF ID 1 (BUY 15주, 가격 9,390원)
-- 기존: 43주 @ 9,684.42원 → 신규: 58주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 58.000000,
    avg_cost = ROUND(((43.000000 * 9684.42) + (15.000000 * 9225.00)) / 58.000000, 2),
    updated_at = '2025-03-03 09:45:00'
WHERE etf_id = 1 AND isa_account_id = 6;

-- 7. ETF ID 26 (SELL 10주, 가격 33,904원)
-- 기존: 17주 @ 32,010원 → 신규: 7주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 7.000000,
    updated_at = '2025-03-03 10:30:00'
WHERE etf_id = 26 AND isa_account_id = 6;

-- 8. ETF ID 40 (SELL 20주, 가격 34,210원)
-- 기존: 52주 @ 32,479.81원 → 신규: 32주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 32.000000,
    updated_at = '2025-03-03 11:15:00'
WHERE etf_id = 40 AND isa_account_id = 6;

-- 9. ETF ID 353 (BUY 15주, 가격 12,970원)
-- 기존: 67주 @ 12,631.34원 → 신규: 82주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 82.000000,
    avg_cost = ROUND(((67.000000 * 12631.34) + (15.000000 * 10720.00)) / 82.000000, 2),
    updated_at = '2025-03-03 15:30:00'
WHERE etf_id = 353 AND isa_account_id = 6;

-- ==============================================
-- 최종 보유 현황 (모든 거래 반영 후)
-- ==============================================
-- ETF ID 1: 58주 @ 9,608.28원 (평균가격)
-- ETF ID 26: 7주 @ 32,010원 (기존 평균가격 유지)
-- ETF ID 40: 32주 @ 32,479.81원 (기존 평균가격 유지)  
-- ETF ID 318: 14주 @ 10,095원 (기존 평균가격 유지)
-- ETF ID 353: 82주 @ 12,693.29원 (평균가격)

-- ==============================================
-- 2025년 4월 거래 내역 반영
-- ==============================================

-- 10. ETF ID 197 (BUY 25주, 가격 40,500원) - 신규 매수
-- 기존: 0주 → 신규: 25주 @ 40,500원
INSERT INTO etf_holding (etf_id, isa_account_id, quantity, avg_cost, acquired_at)
VALUES (197, 6, 25.000000, 40500.00, '2025-04-03 09:45:00');

-- 11. ETF ID 295 (BUY 30주, 가격 13,090원) - 신규 매수
-- 기존: 0주 → 신규: 30주 @ 13,090원
INSERT INTO etf_holding (etf_id, isa_account_id, quantity, avg_cost, acquired_at)
VALUES (295, 6, 30.000000, 13090.00, '2025-04-03 09:45:00');

-- 12. ETF ID 353 (SELL 10주, 가격 13,320원)
-- 기존: 82주 @ 12,693.29원 → 신규: 72주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 72.000000,
    updated_at = '2025-04-03 10:30:00'
WHERE etf_id = 353 AND isa_account_id = 6;

-- ==============================================
-- 최종 보유 현황 (4월 거래 반영 후)
-- ==============================================
-- ETF ID 1: 58주 @ 9,608.28원 (변동 없음)
-- ETF ID 26: 7주 @ 32,010원 (변동 없음)
-- ETF ID 40: 32주 @ 32,479.81원 (변동 없음)
-- ETF ID 197: 25주 @ 40,500원 (신규 추가)
-- ETF ID 295: 30주 @ 13,090원 (신규 추가)
-- ETF ID 318: 14주 @ 10,095원 (변동 없음)
-- ETF ID 353: 72주 @ 12,693.29원 (10주 매도)

-- ==============================================
-- 2025년 5월 거래 내역 반영
-- ==============================================

-- 13. ETF ID 26 (BUY 10주, 가격 34,440원)
-- 기존: 7주 @ 32,010원 → 신규: 17주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 17.000000,
    avg_cost = ROUND(((7.000000 * 32010.00) + (10.000000 * 34440.00)) / 17.000000, 2),
    updated_at = '2025-05-12 09:45:00'
WHERE etf_id = 26 AND isa_account_id = 6;

-- 14. ETF ID 197 (SELL 15주, 가격 47,812원)
-- 기존: 25주 @ 40,500원 → 신규: 10주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 10.000000,
    updated_at = '2025-05-13 09:45:00'
WHERE etf_id = 197 AND isa_account_id = 6;

-- 15. ETF ID 295 (SELL 10주, 가격 13,125원)
-- 기존: 30주 @ 13,090원 → 신규: 20주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 20.000000,
    updated_at = '2025-05-22 12:43:00'
WHERE etf_id = 295 AND isa_account_id = 6;

-- 16. ETF ID 353 (BUY 10주, 가격 12,760원)
-- 기존: 72주 @ 12,693.29원 → 신규: 82주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 82.000000,
    avg_cost = ROUND(((72.000000 * 12693.29) + (10.000000 * 12760.00)) / 82.000000, 2),
    updated_at = '2025-05-27 10:30:00'
WHERE etf_id = 353 AND isa_account_id = 6;

-- ==============================================
-- 최종 보유 현황 (5월 거래 반영 후)
-- ==============================================
-- ETF ID 1: 58주 @ 9,608.28원 (변동 없음)
-- ETF ID 26: 17주 @ 33,434.12원 (10주 추가 매수)
-- ETF ID 40: 32주 @ 32,479.81원 (변동 없음)
-- ETF ID 197: 10주 @ 40,500원 (15주 매도)
-- ETF ID 295: 20주 @ 13,090원 (10주 매도)
-- ETF ID 318: 14주 @ 10,095원 (변동 없음)
-- ETF ID 353: 82주 @ 12,701.46원 (10주 추가 매수)

-- ==============================================
-- 2025년 6월 거래 내역 반영
-- ==============================================

-- 17. ETF ID 1 (BUY 10주, 가격 8,855원)
-- 기존: 58주 @ 9,608.28원 → 신규: 68주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 68.000000,
    avg_cost = ROUND(((58.000000 * 9608.28) + (10.000000 * 8855.00)) / 68.000000, 2),
    updated_at = '2025-06-04 09:45:00'
WHERE etf_id = 1 AND isa_account_id = 6;

-- 18. ETF ID 26 (BUY 28주, 가격 39,640원)
-- 기존: 17주 @ 33,434.12원 → 신규: 45주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 45.000000,
    avg_cost = ROUND(((17.000000 * 33434.12) + (28.000000 * 39640.00)) / 45.000000, 2),
    updated_at = '2025-06-18 09:45:00'
WHERE etf_id = 26 AND isa_account_id = 6;

-- 19. ETF ID 197 (SELL 5주, 가격 49,915원)
-- 기존: 10주 @ 40,500원 → 신규: 5주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 5.000000,
    updated_at = '2025-06-18 09:45:00'
WHERE etf_id = 197 AND isa_account_id = 6;

-- 20. ETF ID 295 (SELL 10주, 가격 13,125원)
-- 기존: 20주 @ 13,090원 → 신규: 10주 @ 기존 평균가격 유지
UPDATE etf_holding 
SET 
    quantity = 10.000000,
    updated_at = '2025-06-09 12:43:00'
WHERE etf_id = 295 AND isa_account_id = 6;

-- 21. ETF ID 318 (SELL 14주, 가격 12,500원) - 전량 매도
-- 기존: 14주 @ 10,095원 → 신규: 0주 (포지션 종료)
DELETE FROM etf_holding 
WHERE etf_id = 318 AND isa_account_id = 6;

-- 22. ETF ID 353 (BUY 10주, 가격 13,900원)
-- 기존: 82주 @ 12,701.46원 → 신규: 92주 @ 평균가격
UPDATE etf_holding 
SET 
    quantity = 92.000000,
    avg_cost = ROUND(((82.000000 * 12701.46) + (10.000000 * 13900.00)) / 92.000000, 2),
    updated_at = '2025-06-16 10:30:00'
WHERE etf_id = 353 AND isa_account_id = 6;

-- ==============================================
-- 최종 보유 현황 (6월 거래 반영 후)
-- ==============================================
-- ETF ID 1: 68주 @ 9,497.47원 (10주 추가 매수)
-- ETF ID 26: 45주 @ 37,449.76원 (28주 추가 매수)
-- ETF ID 40: 32주 @ 32,479.81원 (변동 없음)
-- ETF ID 197: 5주 @ 40,500원 (5주 매도)
-- ETF ID 295: 10주 @ 13,090원 (10주 매도)
-- ETF ID 318: 0주 (전량 매도 - 포지션 종료)
-- ETF ID 353: 92주 @ 12,831.24원 (10주 추가 매수)